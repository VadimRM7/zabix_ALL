#!/usr/bin/env bash

hostname="$HOST_NAME"
server_ip="65.108.196.236"

if [[ -z "$hostname" ]]; then
    echo "Переменная окружения HOST_NAME не установлена"
    exit 1
fi

# Функция для выполнения команд с проверкой на ошибки
run_command() {
    echo "Выполнение команды: sudo $@"
    sudo "$@"
    if [ $? -ne 0 ]; then
        echo "Ошибка при выполнении команды: $@"
    else
        echo "Команда успешно выполнена: $@"
    fi
}

# Удаление старого агента Zabbix
echo "Удаление старого агента Zabbix"
run_command systemctl stop zabbix-agent
run_command apt-get remove --purge -y zabbix-agent
run_command rm -rf /etc/zabbix/

# Установка нового агента Zabbix
echo "Установка нового агента Zabbix"
run_command wget https://repo.zabbix.com/zabbix/6.4/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.4-1+ubuntu22.04_all.deb
run_command dpkg -i zabbix-release_6.4-1+ubuntu22.04_all.deb
run_command apt-get update
run_command apt-get install -y zabbix-agent
run_command systemctl enable zabbix-agent

# Создание конфигурационного файла, если он отсутствует
if [ ! -f /etc/zabbix/zabbix_agentd.conf ]; then
    echo "Конфигурационный файл /etc/zabbix/zabbix_agentd.conf не найден. Создаю файл..."
    run_command cp /usr/share/doc/zabbix-agent/zabbix_agentd.conf /etc/zabbix/
fi

# Конфигурация агента Zabbix
echo "Конфигурация агента Zabbix"
sed -i "s/Hostname=.*/Hostname=$hostname/g" /etc/zabbix/zabbix_agentd.conf
sed -i "s/Server=.*/Server=$server_ip/g" /etc/zabbix/zabbix_agentd.conf
sed -i "s/ServerActive=.*/ServerActive=$server_ip/g" /etc/zabbix/zabbix_agentd.conf
sed -i "s/# HostMetadata=/HostMetadata=autoreg.linux/" /etc/zabbix/zabbix_agentd.conf

# Перезапуск агента Zabbix
run_command systemctl restart zabbix-agent

echo "Агент Zabbix сконфигурирован и запущен"
echo "Скрипт выполнен."

#!/usr/bin/env bash

hostname="$HOST_NAME"
server_ip="65.108.196.236"

error_occurred=0

if [[ -z "$hostname" ]]; then
    echo "Переменная окружения HOST_NAME не установлена"
    exit 1
fi

run_command() {
    echo "Выполнение команды: sudo $@"
    sudo "$@"
    local status=$?
    if [ $status -ne 0 ]; then
        echo "Ошибка при выполнении команды: $1"
        error_occurred=1
    else
        echo "Команда успешно выполнена: $1"
    fi
    return $status
}

check_os_version() {
    . /etc/os-release
    os_version=$VERSION_ID
    if [[ "$os_version" == "22.04" ]]; then
        zabbix_repo="https://repo.zabbix.com/zabbix/6.4/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.4-1+ubuntu22.04_all.deb"
    elif [[ "$os_version" == "20.04" ]]; then
        zabbix_repo="https://repo.zabbix.com/zabbix/6.4/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.4-1+ubuntu20.04_all.deb"
    else
        echo "Неподдерживаемая версия ОС: $os_version. Скрипт поддерживает только Ubuntu 20.04 и 22.04."
        error_occurred=1
    fi
}

remove_old_zabbix(){
    echo "Начало удаления старого агента Zabbix"
    if [[ $(systemctl list-units --full -all | grep "zabbix-agent" | wc -l) -gt 0 ]]; then
        run_command systemctl stop zabbix-agent
        run_command apt remove -y zabbix-agent
    fi
    if [[ -d "/etc/zabbix/" ]]; then
        run_command rm -rf /etc/zabbix/
    fi
    echo "Старый агент Zabbix удалён"
}

install_zabbix(){
    echo "Начало установки агента Zabbix"
    check_os_version
    if [ $error_occurred -eq 0 ]; then
        run_command wget $zabbix_repo
        run_command dpkg -i $(basename $zabbix_repo)
        run_command apt-get update
        run_command apt-get install -y zabbix-agent
        run_command systemctl restart zabbix-agent
        run_command systemctl enable zabbix-agent
        run_command rm -f $(basename $zabbix_repo)
    fi
}

config_zabbix(){
    echo "Начало конфигурации агента Zabbix"
    run_command sed -i "s/Hostname=.*/Hostname=$hostname/g" /etc/zabbix/zabbix_agentd.conf
    run_command sed -i "s/Server=.*/Server=$server_ip/g" /etc/zabbix/zabbix_agentd.conf
    run_command sed -i "s/ServerActive=.*/ServerActive=$server_ip/g" /etc/zabbix/zabbix_agentd.conf
    run_command sed -i "s/# HostMetadata=/HostMetadata=autoreg.linux/" /etc/zabbix/zabbix_agentd.conf
    run_command systemctl restart zabbix-agent
    echo "Агент Zabbix сконфигурирован"
}

echo "Запуск скрипта"
remove_old_zabbix
install_zabbix
config_zabbix

if [ $error_occurred -ne 0 ]; then
    echo "Скрипт завершен с ошибками."
else
    echo "Скрипт успешно выполнен."
fi
